pipeline {
    agent any

    environment {
        REMOTE_HOST = '192.168.2.142'
        REMOTE_USER = 'iman' // SSH user
        INDEX_URL = 'https://raw.githubusercontent.com/ihrahimi/DevOps/main/jenkins/nginx-simple/index.html'
        IMAGE_NAME = 'simple-nginx'
    }

    stages {
        stage('Checkout') {
            steps {
                git url: 'https://github.com/ihrahimi/DevOps.git', branch: 'main'
            }
        }

        stage('Download Updated index.html') {
            steps {
                sh 'curl -o index.html ${INDEX_URL}'
            }
        }

        stage('Send to Remote Builder') {
            steps {
                // Send index.html to remote server
                sh """
                scp index.html ${REMOTE_USER}@${REMOTE_HOST}:/home/${REMOTE_USER}/index.html
                """
            }
        }

        stage('Build Docker Image on Remote') {
            steps {
                // SSH into remote and build Docker image
                sh """
                ssh ${REMOTE_USER}@${REMOTE_HOST} '
                mkdir -p ~/nginx-build &&
                mv ~/index.html ~/nginx-build/index.html &&
                cat > ~/nginx-build/Dockerfile <<EOF
                FROM nginx:latest
                COPY index.html /usr/share/nginx/html/index.html
                EOF
                cd ~/nginx-build &&
                docker build -t ${IMAGE_NAME} .
                '
                """
            }
        }
    }

    post {
        success {
            echo '✅ Docker image built successfully on remote server!'
        }
        failure {
            echo '❌ Pipeline failed.'
        }
    }
}
